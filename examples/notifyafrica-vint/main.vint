// Enhanced NotifyAfrica SMS Sender - Showcasing VintLang Features
import notifyafrica_pkg
import os
import time
import uuid
import dotenv
import json
import crypto
import random
import sysinfo
import string

// Load environment variables
dotenv.load(".env")

// Global config
let app_name = "NotifyAfrica SMS Pro"
let version = "2.0.0"
let total_sent = 0
let total_failed = 0

// Enhanced logging with security hash and better formatting
let logResult = func(level, logMessage) {
    let log_file = "notifyafrica.log"
    let timestamp = time.format(time.now(), "2006-01-02 15:04:05")
    
    // Add security hash using crypto module
    let hash = crypto.hashMD5(logMessage + "security_salt")
    let fullLog = "[" + timestamp + "] [" + level + "] " + logMessage + " (Hash: " + hash + ")\n"
    
    os.writeFile(log_file, fullLog, "append")
    
    // Display with better formatting
    if (level == "ERROR") {
        println("❌ [ERROR] " + logMessage)
    } else if (level == "SUCCESS") {
        println("✅ [SUCCESS] " + logMessage)
    } else if (level == "INFO") {
        println("ℹ️  [INFO] " + logMessage)
    } else {
        println("📢 [" + level + "] " + logMessage)
    }
}

// Generate random verification code using random module
let generateVerificationCode = func() {
    return string(random.int(100000, 999999))
}

// Enhanced recipient input with validation
let getRecipients = func() {
    let recipients = []
    println("\nEnter recipient numbers (comma separated, e.g. +2557654321,+2557123456):")
    let inputStr = input()
    let nums = inputStr.split(",")
    for n in nums {
        let trimmed = n.trim()
        if (trimmed != "") {
            recipients.push({"number": trimmed})
        }
    }
    return recipients
}

// Enhanced main menu with emojis and better design
let mainMenu = func() {
    println("\n" + "="*50)
    println("📱 " + app_name + " v" + version)
    println("="*50)
    println("1. 📤 Send SMS")
    println("2. 🎲 Send SMS with Verification Code")
    println("3. 📊 Dashboard")
    println("4. 📋 View Logs")
    println("5. 🚀 About VintLang Features")
    println("6. 🚪 Exit")
    let choice = input("\nChoose an option (1-6): ")
    return choice
}

// New: Send SMS with verification code feature
let sendVerificationSMS = func() {
    let sender_id = input("Enter sender ID: ")
    let phone = input("Enter recipient phone number: ")
    let name = input("Enter recipient name: ")
    
    // Generate random verification code
    let code = generateVerificationCode()
    let sms = "Hello " + name + "! Your verification code is: " + code + ". Valid for 10 minutes. Thank you!"
    
    println("📝 Generated message: " + sms)
    println("🎲 Generated verification code: " + code)
    
    let recipients = [{"number": phone}]
    let request_id = uuid.generate()
    
    println("\n⏳ Sending verification SMS... [Request ID: " + request_id + "]")
    
    let response = notifyafrica_pkg.sendSMS(sender_id, sms, recipients, "none")
    
    // Enhanced error handling and logging
    if (response.type && response.type() == "ERROR") {
        logResult("ERROR", "Failed to send verification SMS: " + response.message() + " [Request ID: " + request_id + "]")
        total_failed = total_failed + 1
    } else {
        logResult("SUCCESS", "Verification SMS sent to " + phone + " [Code: " + code + "] [Request ID: " + request_id + "]")
        total_sent = total_sent + 1
    }
}

// Enhanced SMS sending flow
let sendSMSFlow = func() {
    let sender_id = input("Enter sender ID: ")
    let sms = input("Enter SMS message: ")
    let recipients = getRecipients()
    let schedule = input("Enter schedule (or 'none'): ")
    if (schedule == "") { schedule = "none" }
    
    let request_id = uuid.generate()
    println("\n⏳ Sending SMS... [Request ID: " + request_id + "]")
    
    let response = notifyafrica_pkg.sendSMS(sender_id, sms, recipients, schedule)
    
    // Enhanced error handling with better logging
    if (response.type && response.type() == "ERROR") {
        logResult("ERROR", "Failed to send SMS: " + response.message() + " [Request ID: " + request_id + "]")
        total_failed = total_failed + 1
    } else {
        logResult("SUCCESS", "SMS sent to " + string(len(recipients)) + " recipients [Request ID: " + request_id + "]")
        total_sent = total_sent + len(recipients)
    }
}

// New: Dashboard with system info and statistics
let showDashboard = func() {
    println("\n" + "="*60)
    println("📊 " + app_name + " Dashboard")
    println("="*60)
    
    // System information using sysinfo module
    println("🖥️  System Information:")
    println("   OS: " + sysinfo.os())
    println("   Architecture: " + sysinfo.arch())
    println("   Current Time: " + time.format(time.now(), "2006-01-02 15:04:05"))
    
    // Statistics
    println("\n📈 SMS Statistics:")
    println("   📤 Total SMS Sent: " + string(total_sent))
    println("   ❌ Total Failed: " + string(total_failed))
    
    let total = total_sent + total_failed
    if (total > 0) {
        let successRate = (total_sent * 100) / total
        println("   ✅ Success Rate: " + string(successRate) + "%")
    } else {
        println("   ✅ Success Rate: N/A (No SMS sent yet)")
    }
    
    // Environment status using dotenv module
    println("\n🔧 Environment Configuration:")
    let token = dotenv.get("NOTIFYAFRICA_TOKEN")
    if (token != "" && token != "your_api_token_here") {
        println("   🔑 API Token: ✅ Configured")
    } else {
        println("   🔑 API Token: ❌ Not configured")
    }
    
    let baseUrl = dotenv.get("NOTIFYAFRICA_BASEURL")
    if (baseUrl != "") {
        println("   🌐 Base URL: ✅ " + baseUrl)
    } else {
        println("   🌐 Base URL: ❌ Using default")
    }
    
    input("\nPress Enter to continue...")
}

// New: Show VintLang features demonstrated
let showFeatures = func() {
    println("\n" + "="*50)
    println("🚀 VintLang Features Demonstrated")
    println("="*50)
    
    println("✅ Modules Used:")
    println("   📦 notifyafrica_pkg - Custom SMS API package")
    println("   🗂️  os - File operations and existence checks")
    println("   ⏰ time - Time formatting and current time")
    println("   🔑 uuid - Unique ID generation")
    println("   🌐 dotenv - Environment variable management")
    println("   📄 json - JSON encoding for data structures")
    println("   🔐 crypto - MD5 hashing for security")
    println("   🎲 random - Random number generation")
    println("   🖥️  sysinfo - System information retrieval")
    println("   📝 string - String manipulation and conversion")
    
    println("\n✅ Language Features Used:")
    println("   🔄 Functions with parameters and return values")
    println("   📊 Dictionaries and arrays")
    println("   🔁 For loops and while loops")
    println("   ❓ Conditional statements (if/else)")
    println("   💾 File I/O operations")
    println("   🎯 Error handling and validation")
    println("   📱 User input and formatted output")
    println("   🔢 Type conversion and string operations")
    
    println("\n✅ Application Features:")
    println("   📤 SMS sending with multiple options")
    println("   🎲 Random verification code generation")
    println("   📊 Real-time statistics tracking")
    println("   🔐 Secure logging with MD5 hashes")
    println("   🖥️  System information display")
    println("   🌐 Environment configuration management")
    println("   📋 Comprehensive activity logging")
    println("   ✨ Enhanced user interface with emojis")
    
    input("\nPress Enter to continue...")
}

// Enhanced log viewing
let viewLog = func() {
    let log_file = "notifyafrica.log"
    println("\n" + "="*40)
    println("📋 Application Logs")
    println("="*40)
    
    if (os.exists(log_file)) {
        let logs = os.readFile(log_file)
        println(logs)
    } else {
        logResult("INFO", "No logs available yet.")
    }
    
    input("\nPress Enter to continue...")
}

// Initialize application with environment check
let initApp = func() {
    println("🚀 Initializing " + app_name + "...")
    
    // Check environment using dotenv
    let token = dotenv.get("NOTIFYAFRICA_TOKEN")
    if (token == "" || token == "your_api_token_here") {
        println("⚠️  Warning: No valid API token found!")
        println("   Please set NOTIFYAFRICA_TOKEN in your .env file")
    } else {
        println("✅ API token loaded successfully")
    }
    
    println("✅ Initialization complete!\n")
    // logResult("INFO", "Application started - " + app_name + " v" + version)
}

// Start the application
initApp()

// Enhanced main loop
while (true) {
    let choice = mainMenu()
    if (choice == "1") {
        sendSMSFlow()
    } else if (choice == "2") {
        sendVerificationSMS()
    } else if (choice == "3") {
        showDashboard()
    } else if (choice == "4") {
        viewLog()
    } else if (choice == "5") {
        showFeatures()
    } else if (choice == "6") {
        println("\n👋 Thank you for using " + app_name + "!")
        println("🎉 Goodbye!")
        logResult("INFO", "Application terminated by user")
        break
    } else {
        println("\n❌ Invalid choice. Please try again.")
    }
}